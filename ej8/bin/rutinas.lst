     1                                  GLOBAL CARGAR_TABLA
     2                                  GLOBAL CARGAR_TABLA_2
     3                                  
     4                                  EXTERN _CONTADOR_TECLAS
     5                                  EXTERN _ENTRADA_TABLA
     6                                  EXTERN _CONTADOR_TECLAS_BYTES
     7                                  EXTERN __INICIO_RAM_TABLA_DIGITOS
     8                                  EXTERN _flag_16_TECLAS
     9                                  
    10                                  section .rutinas
    11                                  USE32
    12                                  
    13                                  
    14                                  ;-----------------------------------------------------------------------------------
    15                                  ;-----------------------------------------------------------------------------------
    16                                  
    17                                  CARGAR_TABLA:
    18                                  
    19 00000000 89E5                        mov ebp, esp  
    20 00000002 8A4504                      mov al, [ebp + 4]						    ;Recibo por la pila, el valor de la tecla
    21 00000005 8B0D[00000000]              mov ecx, [_CONTADOR_TECLAS]     				;Cargo valor del contador,ultima pocision de tecla guardada
    22 0000000B 8881[00000000]              mov [__INICIO_RAM_TABLA_DIGITOS + ecx], al  ;Guardo la tecla en el vector
    23                                                                     				; de la tabla, indicada por el contador
    24 00000011 41                          inc ecx
    25 00000012 83F910                      cmp ecx, 0x10		   ;Comparo si llego a 16 bytes
    26 00000015 7402                        jz RESET_CONTADOR
    27 00000017 EB10                        jmp INCREMENTO_CONTADOR
    28                                  
    29                                  
    30                                      RESET_CONTADOR:
    31 00000019 66BB0100                    mov bx, 0x01			
    32 0000001D 66891D[00000000]            mov [_flag_16_TECLAS], bx	;Activo el flag de que supero las 16 teclas
    33                                  
    34 00000024 B900000000                  mov ecx, 0x0				;Reinicio contador a 0, para poder seguir
    35                                      							;guardando en el mismo vector
    36                                  
    37                                      INCREMENTO_CONTADOR:
    38 00000029 890D[00000000]              mov [_CONTADOR_TECLAS], ecx     ;Guardo el valor del contador incrementado
    39 0000002F C3                          ret                            ;para apuntar al siguiente digito de la tabla
    40                                  
    41                                  ;-----------------------------------------------------------------------------------
    42                                  ;-----------------------------------------------------------------------------------
    43                                  
    44                                  
    45                                  CARGAR_TABLA_2:
    46                                  
    47 00000030 8B0D[00000000]          	mov ecx, [_flag_16_TECLAS]
    48 00000036 83F901                      cmp ecx, 0x01				;Chequeo si hay 16 teclas y el contador di
    49 00000039 7408                        jz TECLAS_16 				;la vuelta, ultimo bit paso 0xF
    50                                  
    51 0000003B 8B0D[00000000]              mov ecx,[_CONTADOR_TECLAS]	; Si hay menos de 16, cargo la cantidad de teclas
    52 00000041 EB1A                        jmp CEROS 					
    53                                  
    54                                      
    55                                     	TECLAS_16:			         
    56 00000043 66BB0000                	mov bx, 0x0					 ;Reseteo el flag de la funcion CARGAR_TABLA
    57 00000047 66891D[00000000]        	mov [_flag_16_TECLAS], bx	 ;que me indica que hubo mas de 16 teclas.
    58 0000004E B910000000                  mov ecx, 0x10				 ;Cargo que la cantidad de teclas son 16
    59 00000053 D1E9                        shr ecx, 0x1                 ;Divido por 2, porque voy a juntar de a 2 hexas en 1 byte
    60 00000055 8B15[00000000]              mov edx, [_CONTADOR_TECLAS_BYTES] ;Cargo la pocision de la entrada de la tabla
    61 0000005B EB44                        jmp GUARDADO_NUMERO
    62                                  
    63                                  
    64                                  
    65                                  
    66                                  	CEROS:				;Completo las pocisiones de las teclas faltantes a 16 con 0				
    67 0000005D B000                    	mov al, 0x00			
    68 0000005F 8881[00000000]          	mov [__INICIO_RAM_TABLA_DIGITOS + ecx], al             
    69                                  
    70 00000065 41                          inc ecx
    71 00000066 83F910                  	cmp ecx, 0x10 		;Chequeo si llegue a la tecla numero 16
    72 00000069 7402                    	jz PARIDAD
    73 0000006B EBF0                    	jmp CEROS
    74                                      
    75                                  	
    76                                  
    77                                  	PARIDAD:    
    78 0000006D 8B0D[00000000]          	mov ecx,[_CONTADOR_TECLAS] 
    79 00000073 F7C101000000               	test ecx,1  				;Compruebo si el numero de teclas ingresadas
    80 00000079 7502                       	jnz IMPAR       			; son pares o impares
    81 0000007B EB1C                       	jmp PAR
    82                                     	
    83                                  
    84                                     	IMPAR:
    85 0000007D 8B15[00000000]             	mov edx, [_CONTADOR_TECLAS_BYTES]
    86 00000083 42                         	inc edx
    87                                  
    88 00000084 A0[00000000]               	mov al,[__INICIO_RAM_TABLA_DIGITOS] ;Cargo la tecla mas significativa
    89 00000089 8B1D[00000000]             	mov ebx,[_ENTRADA_TABLA] 
    90 0000008F 41                         	inc ecx  					;Lo hago PAR redondeando para arriba 
    91 00000090 D1E9                    	shr ecx, 0x1 				;Divido por 2, porque voy a juntar de a 2 hexas en 1 byte
    92                                  
    93 00000092 88440BFF                    mov [ebx + ecx - 0x1], al	;Guardo en la primera pocision, la primer tecla
    94 00000096 49                          dec ecx						;que tiene cargada la letra y un cero.
    95 00000097 EB08                       	jmp GUARDADO_NUMERO
    96                                  
    97                                  
    98                                  
    99                                     	PAR:
   100 00000099 8B15[00000000]             	mov edx, [_CONTADOR_TECLAS_BYTES]
   101 0000009F D1E9                        shr ecx, 0x1 ;Divido por 2, porque voy a juntar de a 2 hexas en 1 byte
   102                                  
   103                                  
   104                                  	GUARDADO_NUMERO: 
   105                                  
   106 000000A1 8A82[00000000]             	mov al,[__INICIO_RAM_TABLA_DIGITOS + edx] ;Recorro las tecla y la siguiente
   107 000000A7 8A9A[01000000]             	mov bl,[__INICIO_RAM_TABLA_DIGITOS + edx + 0x1]
   108 000000AD 83C202                     	add edx, 0x2 ;En el siguiente ciclo, agarro las 2 siguientes
   109 000000B0 8915[00000000]             	mov [_CONTADOR_TECLAS_BYTES], edx 
   110                                  
   111                                  
   112                                  
   113 000000B6 C0E004                     	shl al, 0x4  				;Desplazo el primer byte 4 pocisiones
   114 000000B9 08D8                       	or al, bl	 				;y sumo el hexa de la primera tecla y la segunda
   115                                  
   116 000000BB 8B1D[00000000]             	mov ebx,[_ENTRADA_TABLA] ;Cargo el valor de que entrada de la Tabla estoy
   117 000000C1 88440BFF                    mov [ebx + ecx - 0x1], al 	;Guardo el byte de las dos teclas
   118 000000C5 49                          dec ecx
   119 000000C6 75D9                        jne GUARDADO_NUMERO ;Repito hasta que el contador de cantidad de teclas llegue a cero
   120 000000C8 EB00                        jmp RESET_CONTADOR_2
   121                                  
   122                                  
   123                                      RESET_CONTADOR_2:
   124 000000CA 83C110                      add ecx, 0x10  
   125 000000CD BA00000000                  mov edx, 0x00  
   126 000000D2 8915[00000000]              mov [_CONTADOR_TECLAS_BYTES], edx ; Reseteo el contador que barre las teclas de a dos
   127 000000D8 8915[00000000]              mov [_CONTADOR_TECLAS], edx 	 ; Reseteo el contador con la cantidad de teclas
   128 000000DE 010D[00000000]              add [_ENTRADA_TABLA], ecx  ;Guardo el valor del contador incrementado
   129 000000E4 C3                          ret                           ;para apiuntar a la siguiente entrada de la tabla
