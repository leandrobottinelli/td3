     1                                  
     2                                    ;Entro a modo_proteg
     3                                    ; Necesito copiar la funcion copy en rutinas
     4                                    ; Llamo a la funcion copy para que me copie la ROM a nucleo
     5                                  
     6                                  
     7                                  EXTERN __FIN_PILA
     8                                  EXTERN __SIZE_PILA
     9                                  
    10                                  EXTERN COPY_INIT
    11                                  EXTERN POLLING
    12                                  
    13                                  EXTERN __INICIO_RAM_RUTINAS
    14                                  EXTERN __INICIO_ROM_RUTINAS
    15                                  EXTERN __INICIO_ROM
    16                                  EXTERN __INICIO_RAM_NUCLEO
    17                                  EXTERN __INICIO_ROM_NUCLEO
    18                                  
    19                                  EXTERN __INICIO_RAM_TECLADO_RUTINA
    20                                  EXTERN __INICIO_ROM_TECLADO_RUTINA
    21                                  
    22                                  EXTERN __INICIO_ROM_TABLA_DIGITOS 
    23                                  EXTERN __INICIO_RAM_TABLA_DIGITOS 
    24                                  
    25                                  EXTERN __INICIO_ROM_DATOS 
    26                                  EXTERN __INICIO_RAM_DATOS
    27                                  
    28                                  
    29                                  EXTERN __LONGITUD_RUTINAS
    30                                  EXTERN __LONGITUD_ROM
    31                                  EXTERN __LONGITUD_TECLADO_RUTINA
    32                                  EXTERN __LONGITUD_DATOS
    33                                  
    34                                  GLOBAL _CONTADOR_TABLA
    35                                  GLOBAL FIN_POLLING
    36                                  
    37                                  
    38                                  
    39                                  
    40                                  
    41                                  section .reset
    42                                  arranque:
    43                                  USE16
    44 00000000 B80000                  mov ax,0
    45 00000003 FFE0                    jmp ax
    46                                  ;salto a inicio16
    47 00000005 00<rept>                times 16-($-arranque) db 0
    48                                  
    49                                  section .init
    50 00000000 EB1E                    jmp inicio
    51                                  gdt:
    52 00000002 0000000000000000                  db 0,0,0,0,0,0,0,0  ;Descriptor nulo
    53                                  ds_sel    equ $-gdt
    54 0000000A FFFF00000092CF00                  db 0xFF, 0xFF, 0, 0, 0, 0x92, 0xCF, 0
    55                                  cs_sel    equ $-gdt
    56 00000012 FFFF0000009ACF00                  db 0xFF, 0xFF, 0, 0, 0, 0x9A, 0xCF, 0
    57                                  
    58                                  long_gdt equ $-gdt
    59                                  
    60                                  img_gdtr:
    61 0000001A 1700                    		  dw long_gdt-1
    62 0000001C [02000000]              		  dd gdt
    63                                  
    64                                  
    65                                  inicio:		  
    66 00000020 FA                       cli       ;Deshabilito interrupciones
    67                                   
    68                                  
    69 00000021 66                        db 0x66            ;Requerido para direcciones mayores
    70 00000022 2E0F0116[1A00]            lgdt  [cs:img_gdtr] ;que 0x00FFFFFFF. 
    71 00000028 0F20C0                    mov eax,cr0        ;Habiltaci√≥n bit de modo protegido. 
    72 0000002B 6683C801                  or eax,1
    73 0000002F 0F22C0                    mov cr0,eax
    74                                   	
    75 00000032 66EA[3A000000]1000       jmp dword cs_sel:modo_proteg
    76                                   
    77                                  USE32
    78                                  modo_proteg:
    79 0000003A 6687DB                    xchg bx,bx
    80                                  
    81 0000003D 66B80800                  mov ax,ds_sel
    82 00000041 8ED8                      mov ds,ax
    83 00000043 8ED0                      mov ss,ax
    84 00000045 BC[00000000]              mov esp,__FIN_PILA
    85                                  
    86                                  
    87 0000004A 68[00000000]              push __INICIO_ROM_RUTINAS
    88 0000004F 68[00000000]              push __INICIO_RAM_RUTINAS
    89 00000054 68[00000000]              push __LONGITUD_RUTINAS
    90                                  
    91 00000059 E8(00000000)              call __INICIO_ROM_RUTINAS ;Copio la funcion copy en RAM a mano
    92                                  
    93 0000005E 58                        pop eax
    94 0000005F 58                        pop eax
    95 00000060 58                        pop eax
    96                                  
    97                                  
    98                                  
    99 00000061 68[00000000]              push __INICIO_ROM_NUCLEO
   100 00000066 68[00000000]              push __INICIO_RAM_NUCLEO
   101 0000006B 68[00000000]              push __LONGITUD_ROM
   102                                  
   103                                  
   104 00000070 E8(00000000)              call COPY_INIT            ;Copio toda la ROM en RAM desde
   105 00000075 58                        pop eax                   ;funcion copy en RAM
   106 00000076 58                        pop eax
   107 00000077 58                        pop eax
   108                                  
   109 00000078 E9(00000000)              jmp nucleos
   110                                   
   111                                  
   112                                   ;----------------------------------------------------------------------
   113                                  
   114                                  section .nucleo
   115                                  
   116                                  
   117                                  nucleos:   
   118                                  
   119 00000000 68[00000000]              push __INICIO_ROM_TECLADO_RUTINA
   120 00000005 68[00000000]              push __INICIO_RAM_TECLADO_RUTINA
   121 0000000A 68[00000000]              push __LONGITUD_TECLADO_RUTINA 
   122                                  
   123 0000000F E8(00000000)              call COPY_INIT
   124                                    
   125 00000014 58                        pop eax
   126 00000015 58                        pop eax
   127 00000016 58                        pop eax
   128                                  
   129 00000017 68[00000000]              push __INICIO_ROM_DATOS
   130 0000001C 68[00000000]              push __INICIO_RAM_DATOS
   131 00000021 68[00000000]              push __LONGITUD_DATOS
   132                                  
   133 00000026 E8(00000000)              call COPY_INIT
   134                                    
   135 0000002B 58                        pop eax
   136 0000002C 58                        pop eax
   137 0000002D 58                        pop eax
   138                                  
   139                                  
   140                                  pol:
   141 0000002E 50                        push eax
   142 0000002F E8(00000000)              call POLLING       ; Voy a la funcion de pooling en forma de loop         
   143 00000034 EBF8                      jmp pol            ; hasta la tecla "s"
   144                                  
   145                                  FIN_POLLING:
   146 00000036 90                        nop 
   147                                    halt               ; Se presiono tecla "s", hago halt de todo
   147          ******************       warning: label alone on a line without a colon might be in error [-w+orphan-labels]
   148 00000037 EBFD                      jmp FIN_POLLING
   149                                  
   150                                  ;----------------------------------------------------------------------
   151                                  section .datos
   152                                  
   153 00000000 [0000000000000000]      _CONTADOR_TABLA: dq __INICIO_RAM_TABLA_DIGITOS 
   153          ******************       warning: 64-bit unsigned relocation zero-extended from 32 bits
 [-w+zext-reloc]
   154                                  
   155                                  
   156                                  
   157                                  
   158                                   
   159                                  
